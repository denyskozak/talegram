# Клиентские страницы и API

Этот документ описывает, как три ключевые клиентские страницы мини-приложения Telegram работают с API бэкенда и между собой навигируют.

## Домашняя страница категорий (`HomeCategories`)
- Компонент: `src/pages/HomeCategories/HomeCategories.tsx`.
- Загружает список категорий через `catalogApi.listCategories`, передавая поисковый запрос с задержкой 250 мс для снижения нагрузки на API.
- Дополняет список специальными категориями из `SPECIAL_CATEGORIES` и использует `SPECIAL_CATEGORY_MAP` для навигации к заранее настроенным маршрутам.
- При выборе обычной категории выполняется переход `navigate('/category/${category.id}')`, который открывает страницу списка книг категории.
- Ошибки загрузки отображаются через `ErrorBanner` с возможностью повторной попытки, а состояние без результатов — через `EmptyState`.

## Страница книг категории (`CategoryBooks`)
- Компонент: `src/pages/CategoryBooks/CategoryBooks.tsx`.
- Считывает идентификатор категории из маршрута (`useParams`) и запрашивает её описание с помощью `catalogApi.listCategories`.
- Список книг подгружается батчами через `catalogApi.listBooks`, поддерживаются фильтры: поиск, сортировка (`popular`, `rating`, `new`) и теги.
- Для тегов используется отдельный вызов `getCategoryTags`, который получает до 9 популярных тегов для выбранной категории.
- Пагинация реализована через `cursor` и `useIntersectionObserver`: при прокрутке к «сторожевому» элементу запрашивается следующая порция книг.
- При клике на карточку книги вызывается `navigate('/book/${book.id}')`, что открывает страницу книги.

## Страница книги (`BookPage`)
- Компонент: `src/pages/BookPage/BookPage.tsx`.
- Загружает подробную информацию о книге через `catalogApi.getBook`, а также похожие книги методом `catalogApi.listBooks` по первой категории книги.
- Подтягивает статус покупки и детали доступа через `purchasesApi.getStatus`, взаимодействует с оплатами через `paymentsApi.createInvoice` и подтверждение `purchasesApi.confirm`.
- Поддерживает предпросмотр и чтение книги в оверлее (`ReadingOverlay`), управление отзывами (`ReviewsList`) и отображение рейтинга (`BookRating`).
- В случае ошибок отображает `ErrorBanner`, при отсутствии данных — `EmptyState`.

## Связь с API сервера
- Все описанные вызовы заворачиваются в `catalogApi`, `paymentsApi` и `purchasesApi`, которые используют `trpc`-клиент (`src/shared/api/trpc.ts`).
- TRPC-клиент настроен на `httpBatchLink` с базовым URL, задаваемым переменной окружения `VITE_BACKEND_URL` (по умолчанию `http://localhost:3000`).
- Благодаря батчингу и единообразным типам, клиентские страницы получают типобезопасный доступ к эндпоинтам сервера без необходимости вручную описывать схемы запросов.

## Навигация между страницами
- Все переходы выполняются через `useNavigate` из `react-router-dom`.
- Основные маршруты:
  - `/` — `HomeCategories`.
  - `/category/:id` — `CategoryBooks`.
  - `/book/:id` — `BookPage`.
- Таким образом, пользователь проходит путь: выбор категории → просмотр списка книг → открытие конкретной книги, при этом каждое состояние синхронизировано с серверным API через общий слой `trpc`.
